<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Payment - Diet Subscription</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
</head>
<body>
  <h1>Payment</h1>
  <div id="planDetails"></div>
  <button id="payBtn">Pay Now</button>

  <script>
    // ‚úÖ Always check if data exists in localStorage
    const plan = localStorage.getItem("selectedPlan");
    const price = localStorage.getItem("selectedPrice");
    const email = localStorage.getItem("email");

    // ‚úÖ Fallback check ‚Üí if null then redirect back to index
    if (!plan || !price || !email) {
      alert("Session expired! Please select a plan again.");
      window.location.href = "index.html"; // redirect back to plan page
    }

    // ‚úÖ Show plan details
    document.getElementById("planDetails").innerHTML =
      `<h2>${plan}</h2><p>Price: ‚Çπ${price}</p><p>Email: ${email}</p>`;

    document.getElementById("payBtn").addEventListener("click", async () => {
      try {
        // Step 1: Create order from backend
        const res = await fetch("https://diet-saas.onrender.com/create-order", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ 
            amount: Number(price),   // üëà ensure number
            plan: plan,
            email: email
          })
        });

        const order = await res.json();

        if (!order.id) {
          alert("Failed to create order. Try again.");
          return;
        }

        // Step 2: Open Razorpay checkout
        const options = {
          key: "rzp_test_RDOq87kgys57h2", // Razorpay test key
          amount: order.amount,
          currency: order.currency,
          name: "Diet Subscription",
          description: plan,
          order_id: order.id,
          handler: async function (response) {
            // Step 3: Verify payment
            const verifyRes = await fetch("https://diet-saas.onrender.com/verify-payment", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                name: email.split("@")[0],
                email,
                plan,
                paymentId: response.razorpay_payment_id
              })
            });

            const result = await verifyRes.json();
            if (result.success) {
              alert("‚úÖ Payment Successful! Subscription Activated.");
              window.location.href = "dashboard.html";
            } else {
              alert("‚ùå Payment Failed!");
            }
          },
          prefill: {   // üëà mobile me user details auto-fill
            email: email,
            name: email.split("@")[0]
          },
          theme: { color: "#3399cc" }
        };

        const rzp = new Razorpay(options);
        rzp.open();
      } catch (err) {
        console.error("Payment Error:", err);
        alert("Error starting payment. Try again!");
      }
    });
  </script>
</body>
</html>
