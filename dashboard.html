<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Dashboard</title>
  <style>
    :root { --bg:#f5f7fb; --card:#fff; --accent:#007bff; --muted:#666; }
    body { font-family: Arial, sans-serif; background: var(--bg); margin:0; padding:16px; }
    .container { max-width:720px; margin:10px auto; }
    .top { display:flex; justify-content:space-between; align-items:center; gap:10px; }
    h1 { margin:0; color:#222; font-size:20px; }
    .btn { background:var(--accent); color:#fff; border:none; padding:10px 14px; border-radius:8px; cursor:pointer; }
    .card { background:var(--card); padding:14px; border-radius:10px; margin-top:14px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }
    label { display:block; margin-top:10px; color:var(--muted); font-weight:600; }
    input, select { width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e6e9ee; }
    .meal { border-radius:8px; padding:10px; background:#fafcff; margin-top:8px; }
    ul { padding-left:18px; }
    .small { font-size:0.9rem; color:var(--muted); }
    .totals { margin-top:12px; padding:10px; border-radius:8px; background:#eef4ff; font-weight:600; }
    @media (max-width:480px) { .top { flex-direction:column; align-items:stretch } .btn{ width:100% } }
  </style>
</head>
<body>
  <div class="container">
    <div class="top">
      <h1>My Dashboard</h1>
      <div><button id="logoutBtn" class="btn">Logout</button></div>
    </div>

    <div id="subscriptionStatus" class="card">Checking subscription...</div>

    <div id="assessmentCard" class="card" style="display:none;">
      <h2>Body Assessment</h2>
      <div class="small">Fill details to generate a personalized diet</div>
      <label>Height (cm)</label>
      <input id="height" type="number" placeholder="e.g. 175">
      <label>Weight (kg)</label>
      <input id="weight" type="number" placeholder="e.g. 70">
      <label>Age</label>
      <input id="age" type="number" placeholder="e.g. 28">
      <label>Gender</label>
      <select id="gender"><option value="male">Male</option><option value="female">Female</option></select>
      <label>Activity Level</label>
      <select id="activity">
        <option value="sedentary">Sedentary (little/no exercise)</option>
        <option value="light">Light (1-3 days/week)</option>
        <option value="moderate" selected>Moderate (3-5 days/week)</option>
        <option value="active">Active (6-7 days/week)</option>
        <option value="very_active">Very active (physically heavy job)</option>
      </select>
      <label>Goal</label>
      <select id="goal"><option value="fatloss">Fat Loss</option><option value="muscle">Muscle Gain</option><option value="general">General Fitness</option></select>
      <label>Diet Preference</label>
      <select id="dietType"><option value="veg">Vegetarian</option><option value="nonveg">Non-Vegetarian</option></select>

      <button id="genBtn" class="btn">Generate Plan (Preview)</button>
    </div>

    <div id="dietCard" class="card" style="display:none;">
      <div id="dietHeader"></div>
      <div id="mealsContainer"></div>
      <div id="totalsContainer" class="totals"></div>
      <div style="margin-top:12px; display:flex; gap:8px;">
        <button id="saveBtn" class="btn">Save Plan</button>
        <button id="editBtn" class="btn" style="background:#6c757d">Edit</button>
      </div>
    </div>
  </div>

<script>
  const BASE = "https://diet-saas.onrender.com"; // <-- http://localhost:5000 for local
  const email = localStorage.getItem("userEmail");
  const selectedPlan = sessionStorage.getItem("selectedPlan");

  document.getElementById("logoutBtn").addEventListener("click", ()=> {
    localStorage.clear(); sessionStorage.clear(); window.location.href = "login.html";
  });

  async function checkSubscription() {
    if(!email || !selectedPlan) {
      document.getElementById("subscriptionStatus").innerText = "❌ No plan selected. Please select a plan first.";
      return;
    }
    try {
      const res = await fetch(`${BASE}/check-subscription`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email, plan: selectedPlan })
      });
      const data = await res.json();
      if(data.active) {
        document.getElementById("subscriptionStatus").innerHTML = `✅ Subscription Active — Valid until ${new Date(data.expiry).toDateString()}`;
        loadSavedDiet();
      } else {
        document.getElementById("subscriptionStatus").innerText = "❌ Subscription not found or expired. Please subscribe.";
      }
    } catch (err) {
      console.error(err);
      document.getElementById("subscriptionStatus").innerText = "⚠️ Error connecting to server.";
    }
  }

  async function loadSavedDiet() {
    try {
      const res = await fetch(`${BASE}/get-diet`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ email })
      });
      const data = await res.json();
      if(data.success && data.plan) {
        showDietSaved(data.plan);
      } else {
        document.getElementById("assessmentCard").style.display = "block";
      }
    } catch (err) {
      console.error(err);
      document.getElementById("assessmentCard").style.display = "block";
    }
  }

  document.getElementById("genBtn").addEventListener("click", async () => {
    const height = Number(document.getElementById("height").value);
    const weight = Number(document.getElementById("weight").value);
    const age = Number(document.getElementById("age").value);
    const gender = document.getElementById("gender").value;
    const activity = document.getElementById("activity").value;
    const goal = document.getElementById("goal").value;
    const dietType = document.getElementById("dietType").value;

    if(!height || !weight || !age) return alert("Please fill height/weight/age");

    try {
      const res = await fetch(`${BASE}/generate-diet`, {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({
          email,
          plan: goal,
          age,
          gender,
          weightKg: weight,
          heightCm: height,
          activityLevel: activity,
          dietType,
          save: false
        })
      });
      const data = await res.json();
      if(!data.success) return alert("Error: "+(data.error||data.message));
      showGeneratedPlan(data.plan);
      document.getElementById("dietCard").style.display = "block";
    } catch (err) {
      console.error(err);
      alert("Server error");
    }
  });

  function calcTotals(meals) {
    let total = { kcal:0, protein:0, carbs:0, fats:0 };
    meals.forEach(m => {
      (m.items||[]).forEach(i => {
        total.kcal += i.calories || 0;
        total.protein += i.protein || 0;
        total.carbs += i.carbs || 0;
        total.fats += i.fat || 0;
      });
    });
    return total;
  }

  function renderMeals(meals) {
    return meals.map(m => `
      <div class="meal">
        <strong>${m.slot.toUpperCase()} — ${m.kcal || 0} kcal</strong>
        <ul>${(m.items||[]).map(i=>
          `<li>${i.name} (${i.portion}) — ${i.calories} kcal | P:${i.protein}g C:${i.carbs}g F:${i.fat}g</li>`
        ).join("")}</ul>
      </div>
    `).join("");
  }

  function showGeneratedPlan(plan) {
    document.getElementById("dietHeader").innerHTML = `
      <h2>Preview — ${plan.goal} • target ${plan.targetCalories} kcal</h2>
      <div class="small">Target: Protein ${plan.macrosTarget.protein_g}g • Carbs ${plan.macrosTarget.carbs_g}g • Fats ${plan.macrosTarget.fats_g}g</div>`;

    document.getElementById("mealsContainer").innerHTML = renderMeals(plan.generated.meals);

    const totals = calcTotals(plan.generated.meals);
    document.getElementById("totalsContainer").innerHTML =
      `Total: ${totals.kcal} kcal | Protein ${totals.protein.toFixed(1)}g • Carbs ${totals.carbs.toFixed(1)}g • Fats ${totals.fats.toFixed(1)}g`;

    document.getElementById("saveBtn").onclick = async () => {
      try {
        const payload = { email, plan: {
          goal: plan.goal,
          calories: totals.kcal,
          macros: totals,
          meals: plan.generated.meals
        }};
        const r = await fetch(`${BASE}/save-diet`, {
          method: "POST",
          headers: {"Content-Type":"application/json"},
          body: JSON.stringify(payload)
        });
        const d = await r.json();
        if(d.success) alert("Plan saved!");
        else alert("Save failed");
      } catch (e) { console.error(e); alert("Error saving"); }
    };

    document.getElementById("editBtn").onclick = () => {
      document.getElementById("dietCard").style.display = "none";
      document.getElementById("assessmentCard").style.display = "block";
    };
  }

  function showDietSaved(planDoc) {
    document.getElementById("assessmentCard").style.display = "none";
    document.getElementById("dietCard").style.display = "block";
    document.getElementById("dietHeader").innerHTML =
      `<h2>Saved plan — ${planDoc.goal} • ${planDoc.calories} kcal</h2>`;

    document.getElementById("mealsContainer").innerHTML = renderMeals(planDoc.meals||[]);

    const totals = calcTotals(planDoc.meals||[]);
    document.getElementById("totalsContainer").innerHTML =
      `Total: ${totals.kcal} kcal | Protein ${totals.protein.toFixed(1)}g • Carbs ${totals.carbs.toFixed(1)}g • Fats ${totals.fats.toFixed(1)}g`;

    document.getElementById("saveBtn").onclick = () => {
      alert("Saved already. Use Edit to change the plan.");
    };
    document.getElementById("editBtn").onclick = () => {
      document.getElementById("dietCard").style.display = "none";
      document.getElementById("assessmentCard").style.display = "block";
    };
  }

  checkSubscription();
</script>
</body>
</html>
