<script>
  const BASE = "https://diet-saas.onrender.com";
  const email = localStorage.getItem("userEmail");
  const plan = sessionStorage.getItem("selectedPlan");

  // üî¥ Logout
  document.getElementById("logoutBtn").addEventListener("click", () => {
    localStorage.clear();
    sessionStorage.clear();
    window.location.href = "login.html";
  });

  // Check subscription
  async function checkSubscription() {
    if (!email || !plan) {
      document.getElementById("subscriptionStatus").innerText = "‚ùå No plan selected.";
      return;
    }
    try {
      const res = await fetch(`${BASE}/check-subscription`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, plan })
      });
      const data = await res.json();

      if (data.active) {
        document.getElementById("subscriptionStatus").innerHTML =
          `‚úÖ Subscription Active <br> Valid until: ${new Date(data.expiry).toDateString()}`;
        
        // Check if user has a saved diet
        loadSavedDiet();
      } else {
        document.getElementById("subscriptionStatus").innerText = "‚ùå Subscription expired or not found.";
      }
    } catch (err) {
      console.error("Error:", err);
      document.getElementById("subscriptionStatus").innerText = "‚ö†Ô∏è Error checking subscription.";
    }
  }

  // üîπ Load saved diet if exists
  async function loadSavedDiet() {
    try {
      const res = await fetch(`${BASE}/get-diet`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      const data = await res.json();

      if (data.plan) {
        showDietPlan(data.plan);
      } else {
        document.getElementById("assessmentForm").style.display = "block";
      }
    } catch (err) {
      console.error("Error fetching saved diet:", err);
      document.getElementById("assessmentForm").style.display = "block";
    }
  }

  // üîπ Save diet to backend
  async function saveDiet(planData) {
    try {
      await fetch(`${BASE}/save-diet`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email, plan: planData })
      });
    } catch (err) {
      console.error("Error saving diet:", err);
    }
  }

  // Generate Diet Plan
  function generatePlan() {
    const h = document.getElementById("height").value;
    const w = document.getElementById("weight").value;
    const a = document.getElementById("age").value;
    const g = document.getElementById("gender").value;
    const goal = document.getElementById("goal").value;

    if (!h || !w || !a) {
      alert("Please fill all details");
      return;
    }

    // Simple calorie formula
    let bmr = (g === "male")
      ? 10 * w + 6.25 * h - 5 * a + 5
      : 10 * w + 6.25 * h - 5 * a - 161;

    let calories = goal === "fatloss" ? bmr - 500
                  : goal === "muscle" ? bmr + 400
                  : bmr;

    let meals = [];
    if (goal === "fatloss") {
      meals = [
        "Morning: Green Tea + 5 Almonds",
        "Breakfast: Oats + 2 Egg Whites",
        "Lunch: Brown Rice + Grilled Chicken + Salad",
        "Snack: 1 Fruit + Green Tea",
        "Dinner: 2 Roti + Paneer/Chicken + Veggies"
      ];
    } else if (goal === "muscle") {
      meals = [
        "Morning: Milk + 5 Almonds + 2 Dates",
        "Breakfast: Oats + 5 Egg Whites + 1 Whole Egg",
        "Lunch: Brown Rice + Chicken + Dal + Veggies",
        "Snack: Peanut Butter Sandwich + Banana",
        "Dinner: 3 Roti + Paneer/Chicken/Fish + Salad"
      ];
    } else {
      meals = [
        "Morning: Warm Water + Lemon",
        "Breakfast: Poha/Upma + Green Tea",
        "Lunch: 2 Roti + Sabji + Dal",
        "Snack: 1 Fruit",
        "Dinner: 2 Roti + Paneer/Chicken + Salad"
      ];
    }

    const planData = {
      goal,
      calories: calories.toFixed(0),
      meals
    };

    // Show plan
    showDietPlan(planData);

    // Save plan to backend
    saveDiet(planData);
  }

  // Show diet on page
  function showDietPlan(planData) {
    document.getElementById("assessmentForm").style.display = "none";
    document.getElementById("dietPlan").style.display = "block";
    document.getElementById("dietPlan").innerHTML = `
      <h2>Your ${planData.goal === "fatloss" ? "Fat Loss" : planData.goal === "muscle" ? "Muscle Gain" : "Fitness"} Diet</h2>
      <p><b>Target Calories:</b> ${planData.calories} kcal</p>
      <h3>Meals:</h3>
      <ul>${planData.meals.map(m => `<li>${m}</li>`).join("")}</ul>
      <br>
      <button onclick="editPlan()">‚úèÔ∏è Edit Plan</button>
    `;
  }

  // üîπ Edit Plan Function
  function editPlan() {
    document.getElementById("dietPlan").style.display = "none";
    document.getElementById("assessmentForm").style.display = "block";
  }

  checkSubscription();
</script>
